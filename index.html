<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FMU Plotter ðŸ“ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem 2rem; }
    select, button { margin: 0 .5rem .5rem 0; }
  </style>
</head>
<body>
  <h2>FMU Plotter ðŸ“‰</h2>

  <label for="model-select">Model:</label>
  <select id="model-select">
      <option>FirstOrder</option>
      <option>SecondOrderSystem</option>
  </select>

  <label for="x-select">Xâ€‘axis:</label>
  <select id="x-select"></select>

  <label for="y-select">Yâ€‘axis:</label>
  <select id="y-select"></select>

  <button id="plot-btn">Plot</button>

  <canvas id="myChart" width="900" height="420"></canvas>

  <script>
    // ---------- configuration ----------
    const DEFAULT_API = "https://fmu-backend.onrender.com";
    const API_URL = new URL(window.location.search).searchParams.get('api') || DEFAULT_API;

    // ---------- state ----------
    let chart;          // Chart.js instance (for destroy)
    const modelSel = document.getElementById('model-select');
    const xSel     = document.getElementById('x-select');
    const ySel     = document.getElementById('y-select');
    const btn      = document.getElementById('plot-btn');

    // ---------- helper ----------
    async function loadVariables(model) {
      try {
        const r = await fetch(`${API_URL}/simulate/${model}`);
        if (!r.ok) throw new Error(r.statusText);
        const { variables } = await r.json();

        xSel.innerHTML = ySel.innerHTML = '';
        for (const v of variables) {
          xSel.add(new Option(v, v));
          ySel.add(new Option(v, v));
        }
      } catch (e) {
        alert('Failed to fetch variable list'); console.error(e);
      }
    }

    async function plot() {
      const model = modelSel.value;
      const x = xSel.value, y = ySel.value;
      if (!x || !y) return alert('Pick both X and Y');

      try {
        const r = await fetch(`${API_URL}/data?model=${model}&x=${x}&y=${y}`);
        const data = await r.json();
        if (data.error) throw new Error(data.error);

        // destroy previous chart
        if (chart) { chart.destroy(); }

        chart = new Chart(document.getElementById('myChart').getContext('2d'), {
          type: 'line',
          data: { labels: data.x, datasets: [{
            label: `${model}:  ${y} vs ${x}`,
            data: data.y,
            borderWidth: 2,
            borderColor: '#1f78b4',
            pointRadius: 0,
            fill: false,
            tension: 0.15
          }]},
          options: {
            responsive: true,
            scales: {
              x: { title: { display:true, text: x } },
              y: { title: { display:true, text: y }, beginAtZero:false }
            }
          }
        });
      } catch (e) {
        alert('Plot failed â€“ see console'); console.error(e);
      }
    }

    // ---------- wire up ----------
    modelSel.addEventListener('change', ()=> loadVariables(modelSel.value));
    btn.addEventListener('click', plot);

    // initial load
    loadVariables(modelSel.value);
  </script>
</body>
</html>
